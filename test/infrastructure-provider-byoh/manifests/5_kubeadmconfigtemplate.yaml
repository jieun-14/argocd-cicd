apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  name: ${CLUSTER_NAME}-md-0
  namespace: ${NAMESPACE}
spec:
  template:
    spec:
      preKubeadmCommands:
      - apt -y update
      - apt install -y ca-certificates curl gnupg lsb-release apt-transport-https
      - swapoff -a
      - sed -i '/swap/d' /etc/fstab
      - |
        cat << EOF > /etc/modules-load.d/containerd.conf
        overlay
        br_netfilter
        EOF
      - modprobe overlay
      - modprobe br_netfilter
      - |
        cat << EOF > /etc/sysctl.d/99-kubernetes-cri.conf
        net.bridge.bridge-nf-call-iptables  = 1
        net.ipv4.ip_forward                 = 1
        net.bridge.bridge-nf-call-ip6tables = 1
        EOF
      - sysctl --system
      - curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /usr/share/keyrings/docker.asc
      - chmod a+r /usr/share/keyrings/docker.asc
      - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list
      - curl -fsSL https://pkgs.k8s.io/core:/stable:/${APT_KEY_K8S}/deb/Release.key -o /usr/share/keyrings/kubernetes-apt-keyring.asc
      - echo "deb [signed-by=/usr/share/keyrings/kubernetes-apt-keyring.asc] https://pkgs.k8s.io/core:/stable:/${APT_KEY_K8S}/deb/ /" > /etc/apt/sources.list.d/kubernetes.list
      - apt -y update
      - apt install -y kubelet=${K8S_VERSION} kubeadm=${K8S_VERSION} kubectl=${K8S_VERSION} containerd.io=${CRI_VERSION}
      - containerd config default > /etc/containerd/config.toml
      - sed -i "s/SystemdCgroup = false/SystemdCgroup = true/g" /etc/containerd/config.toml
      - systemctl daemon-reload
      - systemctl enable containerd.service
      - systemctl restart containerd.service
      joinConfiguration:
        caCertPath: /etc/kubernetes/pki/ca.crt
        nodeRegistration:
          criSocket: /var/run/containerd/containerd.sock
          ignorePreflightErrors:
          - Swap
          - DirAvailable--etc-kubernetes-manifests
          - FileAvailable--etc-kubernetes-kubelet.conf
          kubeletExtraArgs:
            healthz-bind-address: "0.0.0.0"
            node-labels: "openstack-control-plane=enabled"
